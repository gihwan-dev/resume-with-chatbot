---
import type { CollectionEntry } from "astro:content"
import ImpactBadgeCards from "@/components/portfolio/impact-badge-cards.astro"
import { Badge } from "@/components/ui/badge"
import type { PortfolioCaseContract } from "@/lib/resume-portfolio/contracts"

interface Props {
  portfolioCase: PortfolioCaseContract
  project: CollectionEntry<"projects">
}

const { portfolioCase, project } = Astro.props
const storyThread = project.data.storyThread

if (!storyThread) {
  throw new Error(`storyThread is required for caseId: ${portfolioCase.caseId}`)
}

type StoryDecision = NonNullable<typeof storyThread>["decisions"][number]

function toChoiceSummary(decision: StoryDecision) {
  return decision.alternative
}

function toValidationRow(metric: string) {
  const [label, ...valueParts] = metric.split(":")
  if (valueParts.length === 0) {
    return {
      label: "지표",
      value: metric.trim(),
    }
  }

  return {
    label: label.trim(),
    value: valueParts.join(":").trim(),
  }
}

function toOperationalLines(text: string) {
  const lines = text
    .split(/(?<=[.!?])\s+/)
    .map((line) => line.trim())
    .filter((line) => line.length > 0)

  if (lines.length === 0) {
    return [text.trim()]
  }

  return lines.slice(0, 2)
}

function toLearnedLines(text: string) {
  const lines = text
    .split(/\r?\n/)
    .map((line) => line.trim())
    .filter((line) => line.length > 0)

  if (lines.length === 0) {
    return [text.trim()]
  }

  return lines
}

const featuredHighlights = storyThread.implementationHighlights.slice(0, 3)
const supportingHighlights = storyThread.implementationHighlights.slice(3)
const implementationGroups = storyThread.implementationGroups
const decisions = storyThread.decisions
const visibleTechStack = project.data.techStack?.slice(0, 3) ?? []
const hiddenTechStack = project.data.techStack?.slice(3) ?? []
const validationRows = storyThread.validationImpact.metrics.map(toValidationRow)
const operationalImpactLines = toOperationalLines(storyThread.validationImpact.operationalImpact)
const learnedLines = toLearnedLines(storyThread.lessonsLearned)
---

<article
  class="group/case relative mb-20 min-w-0 scroll-mt-24 space-y-12 sm:mb-24 sm:space-y-14 lg:space-y-16"
  data-portfolio-case-study
  data-case-id={portfolioCase.caseId}
>
  <section
    id="tldr"
    class="scroll-mt-24 space-y-6 print:break-inside-avoid sm:space-y-7"
    data-portfolio-section="tldr"
  >
    <div class="space-y-3">
      <p class="text-[11px] font-semibold uppercase tracking-[0.22em] text-resume-primary/85">
        Case Study
      </p>
      <h1
        class="break-words text-3xl font-extrabold leading-tight tracking-tight text-resume-text-heading sm:text-4xl print:text-slate-900"
        data-tldr-title
      >
        {portfolioCase.title}
      </h1>
    </div>

    <section class="space-y-5" data-tldr-card>
      <p
        class="break-words text-base leading-relaxed text-resume-text-main sm:text-[17px] print:text-slate-800"
        data-tldr-summary
        data-tldr-description
      >
        {storyThread.tldrSummary}
      </p>

      <ImpactBadgeCards impacts={storyThread.keyMetrics} />

      <p
        class="break-words text-sm leading-relaxed text-resume-text-main/90 sm:text-[15px] print:text-slate-800"
        data-core-approach
      >
        <span class="font-semibold text-resume-text-heading print:text-slate-900">핵심 접근:</span>
        {storyThread.coreApproach}
      </p>
    </section>

    {project.data.techStack && project.data.techStack.length > 0 && (
      <div class="space-y-2.5" data-tldr-tech-stack>
        <p class="text-[11px] font-semibold uppercase tracking-[0.16em] text-resume-text-muted">
          Core Stack
        </p>
        <div class="flex flex-wrap gap-1.5 sm:gap-2">
          {visibleTechStack.map((tech) => (
            <Badge
              variant="outline"
              className="bg-resume-card-bg/85 border-resume-border/70 px-2 py-0.5 text-[11px] font-normal text-resume-text-main/85"
              data-tldr-tech-item
            >
              {tech}
            </Badge>
          ))}
        </div>
        {hiddenTechStack.length > 0 && (
          <details class="group/stack w-fit">
            <summary class="list-none cursor-pointer text-xs font-medium text-resume-text-muted transition-colors hover:text-resume-text-heading">
              + {hiddenTechStack.length} more
            </summary>
            <div class="mt-2 flex flex-wrap gap-1.5 sm:gap-2">
              {hiddenTechStack.map((tech) => (
                <Badge
                  variant="outline"
                  className="bg-resume-card-bg/80 border-resume-border/65 px-2 py-0.5 text-[11px] font-normal text-resume-text-main/80"
                  data-tldr-tech-item
                >
                  {tech}
                </Badge>
              ))}
            </div>
          </details>
        )}
      </div>
    )}
  </section>

  <section
    id="problem-definition"
    class="scroll-mt-24 space-y-4 print:break-inside-avoid sm:space-y-5"
    data-portfolio-section="problem-definition"
  >
    <h2
      class="text-xl font-bold tracking-tight text-resume-text-heading sm:text-2xl print:text-slate-900"
      data-problem-definition-title
    >
      문제 정의
    </h2>
    <p
      class="break-words text-sm leading-relaxed text-resume-text-main/90 sm:text-[15px] print:text-slate-800"
      data-problem-definition-summary
    >
      {storyThread.problemDefinition}
    </p>
    <ul
      class="list-outside list-disc space-y-2 break-words pl-5 text-sm leading-relaxed text-resume-text-main/90 marker:text-rose-500 print:text-slate-800"
      data-problem-points
    >
      {storyThread.problemPoints.map((point) => (
        <li data-problem-point-item>{point}</li>
      ))}
    </ul>
  </section>

  <section
    id="key-decisions"
    class="scroll-mt-24 space-y-5 print:break-inside-avoid sm:space-y-6"
    data-portfolio-section="key-decisions"
  >
    <h2
      class="text-xl font-bold tracking-tight text-resume-text-heading sm:text-2xl print:text-slate-900"
      data-key-decisions-title
    >
      핵심 의사결정
    </h2>
    <ol class="space-y-3.5 sm:space-y-4" data-decision-list>
      {decisions.map((decision, index) => (
        <li
          class="print:break-inside-avoid"
          data-decision-item
          data-decision-primary-item={index === 0 ? "true" : undefined}
          data-decision-secondary-item={index > 0 ? "true" : undefined}
          data-decision-index={index}
        >
          <details
            open={index === 0}
            class="group/decision rounded-lg border border-resume-border/45 bg-resume-bg/40 px-4 py-3 sm:px-5"
          >
            <summary class="list-none cursor-pointer">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0 space-y-1">
                  <h3
                    class="break-words leading-snug text-resume-text-heading print:text-slate-900"
                    class:list={[
                      index === 0
                        ? "text-lg font-bold sm:text-xl"
                        : "text-sm font-semibold sm:text-base",
                    ]}
                    data-decision-title
                  >
                    {decision.title}
                  </h3>
                  <p class="break-words text-xs leading-relaxed text-resume-text-muted">
                    {decision.alternative}
                  </p>
                </div>
                <span class="mt-0.5 shrink-0 text-sm font-semibold text-resume-text-muted" aria-hidden>
                  <span class="group-open/decision:hidden">+</span>
                  <span class="hidden group-open/decision:inline">-</span>
                </span>
              </div>
            </summary>

            <div class="mt-3 space-y-2 border-t border-resume-border/30 pt-3">
              <p
                class="break-words text-sm leading-relaxed text-resume-text-main/90 sm:text-[15px] print:text-slate-800"
                data-decision-why
              >
                {decision.whyThisChoice}
              </p>

              <p
                class="break-words text-sm leading-relaxed text-resume-text-main/85 sm:text-[15px] print:text-slate-800"
                data-decision-tradeoff
              >
                {decision.tradeOff}
              </p>
            </div>

            {index === 0 ? (
              <p class="hidden" aria-hidden="true" data-decision-alternative-fallback>
                {decision.alternative}
              </p>
            ) : (
              <p class="hidden" aria-hidden="true" data-decision-choice-summary>
                {toChoiceSummary(decision)}
              </p>
            )}
          </details>
        </li>
      ))}
    </ol>
  </section>

  <section
    id="implementation-highlights"
    class="scroll-mt-24 space-y-4 print:break-inside-avoid sm:space-y-5"
    data-portfolio-section="implementation-highlights"
  >
    <h2
      class="text-xl font-bold tracking-tight text-resume-text-heading sm:text-2xl print:text-slate-900"
      data-implementation-highlights-title
    >
      구현 전략
    </h2>
    {implementationGroups && implementationGroups.length > 0 ? (
      <div class="space-y-5" data-implementation-groups>
        {implementationGroups.map((group) => (
          <section class="space-y-2.5">
            <h3
              class="text-xs font-semibold uppercase tracking-wide text-resume-text-muted print:text-slate-700"
              data-implementation-group-title
            >
              {group.title}
            </h3>
            <ul
              class="list-outside list-disc space-y-2 break-words pl-5 text-sm leading-relaxed text-resume-text-main/90 marker:text-sky-500 print:text-slate-800"
              data-implementation-highlights-list
            >
              {group.items.map((item) => (
                <li data-implementation-highlight-item>{item}</li>
              ))}
            </ul>
          </section>
        ))}
      </div>
    ) : (
      <div class="space-y-4" data-implementation-groups>
        <section class="space-y-2">
          <h3 class="text-xs font-semibold uppercase tracking-wide text-resume-text-muted print:text-slate-700">
            Top 3 Highlights
          </h3>
          <ul
            class="list-outside list-disc space-y-2 break-words pl-5 text-sm leading-relaxed text-resume-text-main/90 marker:text-sky-500 print:text-slate-800"
            data-implementation-highlights-list
          >
            {featuredHighlights.map((item) => (
              <li data-implementation-highlight-item data-implementation-tier="core">
                {item}
              </li>
            ))}
          </ul>
        </section>

        {supportingHighlights.length > 0 && (
          <details class="group/implementation w-fit max-w-full">
            <summary class="list-none cursor-pointer text-xs font-medium uppercase tracking-wide text-resume-text-muted transition-colors hover:text-resume-text-heading">
              보강 항목 {supportingHighlights.length}개 보기
            </summary>
            <ul class="mt-2 list-outside list-disc space-y-2 break-words pl-5 text-sm leading-relaxed text-resume-text-main/85 marker:text-cyan-500 print:text-slate-800">
              {supportingHighlights.map((item) => (
                <li data-implementation-highlight-item data-implementation-tier="supporting">
                  {item}
                </li>
              ))}
            </ul>
          </details>
        )}
      </div>
    )}
  </section>

  <section
    id="validation-impact"
    class="scroll-mt-24 space-y-4 print:break-inside-avoid sm:space-y-5"
    data-portfolio-section="validation-impact"
  >
    <h2
      class="text-xl font-bold tracking-tight text-resume-text-heading sm:text-2xl print:text-slate-900"
      data-validation-impact-title
    >
      검증 및 결과
    </h2>
    <div class="overflow-x-auto">
      <table class="w-full border-collapse text-left" data-validation-result-table>
        <tbody>
          {validationRows.map((row) => (
            <tr class="border-b border-resume-border/35 last:border-b-0">
              <th class="w-2/5 py-2 pr-3 text-xs font-semibold uppercase tracking-wide text-resume-text-muted sm:w-1/3">
                {row.label}
              </th>
              <td class="py-2 text-sm font-medium text-resume-text-heading print:text-slate-900">
                {row.value}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <ul class="sr-only" data-validation-metrics-list>
      {storyThread.validationImpact.metrics.map((metric) => (
        <li data-validation-metric-item>{metric}</li>
      ))}
    </ul>

    <p
      class="break-words text-[15px] leading-relaxed text-resume-text-main/90 sm:text-base print:text-slate-800"
      data-operational-impact
    >
      {operationalImpactLines.map((line) => (
        <span class="block">{line}</span>
      ))}
    </p>

    <details
      class="group/measurement rounded-md border border-resume-border/45 px-3 py-2"
      data-measurement-method-section
    >
      <summary
        class="list-none cursor-pointer text-xs font-semibold uppercase tracking-wide text-resume-text-muted transition-colors hover:text-resume-text-heading"
        data-measurement-toggle
      >
        <span class="inline-flex items-center gap-2">
          Measurement
          <span aria-hidden>
            <span class="group-open/measurement:hidden">+</span>
            <span class="hidden group-open/measurement:inline">-</span>
          </span>
        </span>
      </summary>
      <p
        class="mt-2 break-words text-sm leading-relaxed text-resume-text-main/90 print:text-slate-800"
        data-measurement-method
      >
        {storyThread.validationImpact.measurementMethod}
      </p>
    </details>
  </section>

  <section
    id="learned"
    class="scroll-mt-24 space-y-3 print:break-inside-avoid sm:space-y-4"
    data-portfolio-section="learned"
  >
    <h2
      class="text-xl font-bold tracking-tight text-resume-text-heading sm:text-2xl print:text-slate-900"
      data-learned-title
    >
      What I Learned
    </h2>
    <ul
      class="list-outside list-disc space-y-2 break-words pl-5 text-[15px] leading-relaxed text-resume-text-main/90 sm:text-base print:text-slate-800"
      data-learned-text
    >
      {learnedLines.map((line) => (
        <li>{line}</li>
      ))}
    </ul>
  </section>

</article>
