---
import type { CollectionEntry } from "astro:content"
import ImpactBadgeCards from "@/components/portfolio/impact-badge-cards.astro"
import { Badge } from "@/components/ui/badge"
import type { PortfolioCaseContract } from "@/lib/resume-portfolio/contracts"

interface Props {
  portfolioCase: PortfolioCaseContract
  project: CollectionEntry<"projects">
}

const { portfolioCase, project } = Astro.props
const storyThread = project.data.storyThread

if (!storyThread) {
  throw new Error(`storyThread is required for caseId: ${portfolioCase.caseId}`)
}

type StoryDecision = NonNullable<typeof storyThread>["decisions"][number]

function toDecisionNarrative(decision: StoryDecision) {
  return `${decision.whyThisChoice} ${decision.alternative} ${decision.tradeOff}`
}

const coreHighlights = storyThread.implementationHighlights.slice(0, 2)
const supportingHighlights = storyThread.implementationHighlights.slice(2)
const decisions = storyThread.decisions

function toChoiceSummary(decision: StoryDecision) {
  return decision.alternative
}
---

<article
  class="group/case relative mb-20 min-w-0 scroll-mt-24 space-y-12 sm:mb-24 sm:space-y-14 lg:space-y-16"
  data-portfolio-case-study
  data-case-id={portfolioCase.caseId}
>
  <section
    id="tldr"
    class="scroll-mt-24 space-y-6 print:break-inside-avoid sm:space-y-7"
    data-portfolio-section="tldr"
  >
    <div class="space-y-3">
      <p class="text-[11px] font-semibold uppercase tracking-[0.22em] text-resume-primary/85">
        Case Study
      </p>
      <h1
        class="break-words text-3xl font-extrabold leading-tight tracking-tight text-resume-text-heading sm:text-4xl print:text-slate-900"
        data-tldr-title
      >
        {portfolioCase.title}
      </h1>
    </div>

    <section class="space-y-6" data-tldr-card>
      <p
        class="break-words text-base leading-relaxed text-resume-text-main sm:text-[17px] print:text-slate-800"
        data-tldr-summary
        data-tldr-description
      >
        {storyThread.tldrSummary}
      </p>

      <ImpactBadgeCards impacts={storyThread.keyMetrics} />

      <p
        class="break-words text-sm leading-relaxed text-resume-text-main/90 sm:text-[15px] print:text-slate-800"
        data-core-approach
      >
        <span class="font-semibold text-resume-text-heading print:text-slate-900">핵심 접근:</span>
        {storyThread.coreApproach}
      </p>
    </section>

    {project.data.techStack && project.data.techStack.length > 0 && (
      <div class="flex flex-wrap gap-1.5 sm:gap-2" data-tldr-tech-stack>
        {project.data.techStack.map((tech) => (
          <Badge
            variant="outline"
            className="bg-resume-card-bg/85 border-resume-border/70 px-2 py-0.5 text-[11px] font-normal text-resume-text-main/85"
            data-tldr-tech-item
          >
            {tech}
          </Badge>
        ))}
      </div>
    )}
  </section>

  <section
    id="problem-definition"
    class="scroll-mt-24 space-y-4 print:break-inside-avoid sm:space-y-5"
    data-portfolio-section="problem-definition"
  >
    <h2
      class="text-xl font-bold tracking-tight text-resume-text-heading sm:text-2xl print:text-slate-900"
      data-problem-definition-title
    >
      문제 정의
    </h2>
    <ul
      class="space-y-2 break-words pl-5 text-sm leading-relaxed text-resume-text-main/90 marker:text-rose-500 print:text-slate-800"
      data-problem-points
    >
      {storyThread.problemPoints.map((point) => (
        <li data-problem-point-item>{point}</li>
      ))}
    </ul>
  </section>

  <section
    id="key-decisions"
    class="scroll-mt-24 space-y-5 print:break-inside-avoid sm:space-y-6"
    data-portfolio-section="key-decisions"
  >
    <h2
      class="text-xl font-bold tracking-tight text-resume-text-heading sm:text-2xl print:text-slate-900"
      data-key-decisions-title
    >
      핵심 의사결정
    </h2>
    <ol class="space-y-5 sm:space-y-6" data-decision-list>
      {decisions.map((decision, index) => (
        index === 0 ? (
          <li
            class="space-y-2.5 print:break-inside-avoid"
            data-decision-item
            data-decision-primary-item
            data-decision-index={index}
          >
            <h3
              class="break-words text-lg font-bold leading-snug text-resume-text-heading sm:text-xl print:text-slate-900"
              data-decision-title
            >
              {decision.title}
            </h3>
            <p
              class="break-words text-[15px] leading-relaxed text-resume-text-main/90 sm:text-base print:text-slate-800"
              data-decision-why
            >
              {toDecisionNarrative(decision)}
            </p>

            <p class="sr-only" data-decision-alternative-fallback>
              {decision.alternative}
            </p>

            <p class="sr-only" data-decision-alternative>
              {decision.alternative}
            </p>

            <p class="sr-only" data-decision-tradeoff>
              {decision.tradeOff}
            </p>
          </li>
        ) : (
          <li
            class="space-y-2.5 print:break-inside-avoid"
            data-decision-item
            data-decision-secondary-item
            data-decision-index={index}
          >
            <h3
              class="break-words text-sm font-semibold leading-snug text-resume-text-heading sm:text-base print:text-slate-900"
              data-decision-title
            >
              {decision.title}
            </h3>
            <p
              class="break-words text-sm leading-relaxed text-resume-text-main/90 print:text-slate-800"
              data-decision-why
            >
              {toDecisionNarrative(decision)}
            </p>
            <p class="sr-only" data-decision-choice-summary>{toChoiceSummary(decision)}</p>
            <p class="sr-only" data-decision-alternative>
              {decision.alternative}
            </p>
            <p class="sr-only" data-decision-tradeoff>{decision.tradeOff}</p>
          </li>
        )
      ))}
    </ol>
  </section>

  <section
    id="implementation-highlights"
    class="scroll-mt-24 space-y-4 print:break-inside-avoid sm:space-y-5"
    data-portfolio-section="implementation-highlights"
  >
    <h2
      class="text-xl font-bold tracking-tight text-resume-text-heading sm:text-2xl print:text-slate-900"
      data-implementation-highlights-title
    >
      구현 전략
    </h2>
    <div class="space-y-6" data-implementation-groups>
      <section class="space-y-2">
        <h3 class="text-xs font-semibold uppercase tracking-wide text-resume-text-muted print:text-slate-700">
          핵심
        </h3>
        <ul
          class="space-y-2 break-words pl-4 text-sm leading-relaxed text-resume-text-main/90 marker:text-sky-500 print:text-slate-800"
          data-implementation-highlights-list
        >
          {coreHighlights.map((item) => (
            <li data-implementation-highlight-item data-implementation-tier="core">
              {item}
            </li>
          ))}
        </ul>
      </section>

      {supportingHighlights.length > 0 && (
        <section class="space-y-2">
          <h3 class="text-xs font-semibold uppercase tracking-wide text-resume-text-muted print:text-slate-700">
            보강
          </h3>
          <ul class="space-y-2 break-words pl-4 text-sm leading-relaxed text-resume-text-main/90 marker:text-cyan-500 print:text-slate-800">
            {supportingHighlights.map((item) => (
              <li data-implementation-highlight-item data-implementation-tier="supporting">
                {item}
              </li>
            ))}
          </ul>
        </section>
      )}
    </div>
  </section>

  <section
    id="validation-impact"
    class="scroll-mt-24 space-y-4 print:break-inside-avoid sm:space-y-5"
    data-portfolio-section="validation-impact"
  >
    <h2
      class="text-xl font-bold tracking-tight text-resume-text-heading sm:text-2xl print:text-slate-900"
      data-validation-impact-title
    >
      검증 및 결과
    </h2>
    <section
      class="space-y-2"
      data-measurement-method-section
    >
      <h3 class="text-sm font-bold uppercase tracking-wide text-resume-text-heading print:text-slate-900">
        측정 방식
      </h3>
      <p
        class="break-words text-sm leading-relaxed text-resume-text-main/90 print:text-slate-800"
        data-measurement-method
      >
        {storyThread.validationImpact.measurementMethod}
      </p>
    </section>
    <ul
      class="space-y-2 break-words pl-5 text-sm leading-relaxed text-resume-text-main/85 marker:text-emerald-500 print:text-slate-800"
      data-validation-metrics-list
    >
      {storyThread.validationImpact.metrics.map((metric) => (
        <li data-validation-metric-item>{metric}</li>
      ))}
    </ul>
    <p
      class="break-words text-[15px] leading-relaxed text-resume-text-main/90 sm:text-base print:text-slate-800"
      data-operational-impact
    >
      {storyThread.validationImpact.operationalImpact}
    </p>
  </section>

  <section
    id="learned"
    class="scroll-mt-24 space-y-3 print:break-inside-avoid sm:space-y-4"
    data-portfolio-section="learned"
  >
    <h2
      class="text-xl font-bold tracking-tight text-resume-text-heading sm:text-2xl print:text-slate-900"
      data-learned-title
    >
      What I Learned
    </h2>
    <p
      class="break-words text-[15px] leading-relaxed text-resume-text-main/90 sm:text-base print:text-slate-800"
      data-learned-text
    >
      {storyThread.lessonsLearned}
    </p>
  </section>

</article>
