---
import type { CollectionEntry } from "astro:content"
import ImpactBadgeCards from "@/components/portfolio/impact-badge-cards.astro"
import StoryThreadTimeline from "@/components/portfolio/story-thread-timeline.astro"
import { Badge } from "@/components/ui/badge"
import { Separator } from "@/components/ui/separator"
import type { PortfolioCaseContract } from "@/lib/resume-portfolio/contracts"

interface Props {
  portfolioCase: PortfolioCaseContract
  project: CollectionEntry<"projects">
}

const { portfolioCase, project } = Astro.props
const storyThread = project.data.storyThread

if (!storyThread) {
  throw new Error(`storyThread is required for caseId: ${portfolioCase.caseId}`)
}

const architectureSummaryLines = storyThread.architectureSummary
  ? storyThread.architectureSummary
      .split("\n")
      .map((line) => line.trim())
      .filter((line) => line.length > 0)
  : []
---

<article
  class="group/case relative mb-20 min-w-0 scroll-mt-24 space-y-12 sm:mb-24 sm:space-y-14 lg:space-y-16"
  data-portfolio-case-study
  data-case-id={portfolioCase.caseId}
>
  <section
    id="hook"
    class="scroll-mt-24 space-y-6 print:break-inside-avoid sm:space-y-8"
    data-portfolio-section="hook"
  >
    <div class="space-y-4 sm:space-y-5">
      <p class="text-sm font-semibold uppercase tracking-[0.2em] text-resume-primary">
        Case Study
      </p>
      <h1
        class="break-words text-2xl font-extrabold leading-tight tracking-tight text-resume-text-heading sm:text-4xl print:text-slate-900"
        data-hook-title
      >
        {portfolioCase.title}
      </h1>
      <p
        class="break-words text-base leading-relaxed text-resume-text-main/85 sm:text-lg print:text-slate-800"
        data-hook-summary
      >
        {project.data.description}
      </p>
    </div>

    {project.data.techStack && project.data.techStack.length > 0 && (
      <div class="flex flex-wrap gap-2" data-hook-tech-stack>
        {project.data.techStack.map((tech) => (
          <Badge
            variant="outline"
            className="text-sm font-normal bg-resume-card-bg text-resume-text-main border-resume-border"
            data-hook-tech-item
          >
            {tech}
          </Badge>
        ))}
      </div>
    )}

    <ImpactBadgeCards impacts={storyThread.impacts} />

    {architectureSummaryLines.length > 0 && (
      <section
        class="space-y-3 rounded-xl border border-resume-border/80 bg-resume-card-bg/70 p-4 sm:p-5 print:border-slate-300 print:bg-white"
        data-architecture-summary
      >
        <h2 class="text-sm font-bold uppercase tracking-wide text-resume-text-heading print:text-slate-900">
          Architecture Summary
        </h2>
        <ul class="space-y-2 pl-5 text-sm leading-relaxed text-resume-text-main/90 marker:text-resume-primary print:text-slate-800">
          {architectureSummaryLines.map((line) => (
            <li data-architecture-summary-item>{line}</li>
          ))}
        </ul>
      </section>
    )}

    {storyThread.measurementMethod && (
      <section
        class="space-y-2 rounded-xl border border-resume-primary/20 bg-resume-highlight/40 px-4 py-3 sm:px-5 print:border-slate-300 print:bg-slate-100/40"
        data-measurement-method-section
      >
        <h2 class="text-sm font-bold uppercase tracking-wide text-resume-text-heading print:text-slate-900">
          Measurement Method
        </h2>
        <p
          class="break-words text-sm leading-relaxed text-resume-text-main/90 print:text-slate-800"
          data-measurement-method
        >
          {storyThread.measurementMethod}
        </p>
      </section>
    )}
  </section>

  <section
    id="context"
    class="scroll-mt-24 space-y-3 print:break-inside-avoid sm:space-y-4"
    data-portfolio-section="context"
  >
    <h2
      class="text-xl font-bold tracking-tight text-resume-text-heading sm:text-2xl print:text-slate-900"
      data-context-title
    >
      Context
    </h2>
    <p
      class="break-words text-[15px] leading-relaxed text-resume-text-main/90 sm:text-base print:text-slate-800"
      data-context-text
    >
      {storyThread.context}
    </p>
  </section>

  <section
    id="threads"
    class="scroll-mt-24 space-y-5 print:break-inside-avoid sm:space-y-6"
    data-portfolio-section="threads"
  >
    <h2
      class="text-xl font-bold tracking-tight text-resume-text-heading sm:text-2xl print:text-slate-900"
      data-threads-title
    >
      Story Threads
    </h2>
    <StoryThreadTimeline threads={storyThread.threads} />
  </section>

  <section
    id="retrospective"
    class="scroll-mt-24 space-y-3 print:break-inside-avoid sm:space-y-4"
    data-portfolio-section="retrospective"
  >
    <h2
      class="text-xl font-bold tracking-tight text-resume-text-heading sm:text-2xl print:text-slate-900"
      data-retrospective-title
    >
      What I Learned
    </h2>
    <p
      class="break-words text-[15px] leading-relaxed text-resume-text-main/90 sm:text-base print:text-slate-800"
      data-retrospective-text
    >
      {storyThread.lessonsLearned}
    </p>
  </section>

  <Separator className="mt-10 print:hidden" />
</article>
