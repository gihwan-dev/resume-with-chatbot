---
import { getCollection, render } from "astro:content"
import CaseStudySection from "@/components/portfolio/case-study-section.astro"
import TableOfContents from "@/components/portfolio/table-of-contents.astro"
import Layout from "@/layouts/Layout.astro"
import { PORTFOLIO_CASES_V1 } from "@/lib/resume-portfolio/mapping"

const projects = await getCollection("projects")

// PORTFOLIO_CASES_V1 순서대로 프로젝트를 불러옵니다.
const portfolioProjects = await Promise.all(
  PORTFOLIO_CASES_V1.map(async (portfolioCase) => {
    // caseId matches the slug/id of the project in astro:content
    const project = projects.find((p) => p.id === portfolioCase.caseId)
    if (!project) return null

    const { Content } = await render(project)
    return { portfolioCase, project, Content }
  })
).then((results) => results.filter((r) => r !== null))
---

<Layout title="최기환 포트폴리오 | AI와 함께하는 개발자 이력서">
  <div class="container mx-auto py-12 px-4 sm:px-6 lg:px-8 print:py-0 print:px-0 print:max-w-full">
    
    <div class="mb-12 print:hidden">
      <a href="/" class="inline-flex items-center text-sm font-medium text-resume-text-muted hover:text-resume-primary transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-4 w-4">
          <path d="m15 18-6-6 6-6"/>
        </svg>
        이력서로 돌아가기
      </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-[250px_1fr] xl:grid-cols-[300px_1fr] gap-12 lg:gap-24 relative">
      <aside class="hidden lg:block">
        <TableOfContents cases={PORTFOLIO_CASES_V1} />
      </aside>

      <main class="w-full max-w-[800px] print:max-w-full print:w-full">
        <div class="print:mb-12 hidden print:block">
          <h1 class="text-4xl font-bold mb-2">포트폴리오 상세 케이스 스터디</h1>
          <p class="text-resume-text-muted">최기환 (Gihwan-dev)</p>
          <hr class="mt-8 mb-12 border-resume-border" />
        </div>

        {
          portfolioProjects.map((data) => (
            data && <CaseStudySection 
              portfolioCase={data.portfolioCase} 
              project={data.project} 
            >
              <data.Content />
            </CaseStudySection>
          ))
        }
      </main>
    </div>
  </div>
</Layout>
