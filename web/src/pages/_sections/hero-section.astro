---
interface ProfileLink {
  network: string
  url: string
}

interface ProfileData {
  name?: string
  label?: string
  email?: string
  url?: string
  summary?: string
  profiles?: ProfileLink[]
}

interface SummarySegment {
  text: string
  highlight: boolean
}

const SUMMARY_HIGHLIGHT_TOKENS = [
  "리사이징, 드래그 앤 드롭",
  "커스텀 데이터 그리드",
  "this 바인딩",
  "코어 자바스크립트",
  "실시간 폴링",
  "20+ 기능",
  "10 FPS",
  "60 FPS",
  "3,000대",
  "300대",
  "Echarts",
  "Visx",
]

const { profile } = Astro.props as { profile?: ProfileData }
const sortedSummaryHighlightTokens = [...SUMMARY_HIGHLIGHT_TOKENS].sort(
  (a, b) => b.length - a.length
)

const tokenizeSummary = (summary?: string): SummarySegment[] => {
  if (!summary) return []

  const segments: SummarySegment[] = []
  let cursor = 0

  while (cursor < summary.length) {
    const matchedToken = sortedSummaryHighlightTokens.find((token) =>
      summary.startsWith(token, cursor)
    )

    if (matchedToken) {
      segments.push({ text: matchedToken, highlight: true })
      cursor += matchedToken.length
      continue
    }

    let nextHighlightIndex = summary.length
    for (const token of sortedSummaryHighlightTokens) {
      const tokenIndex = summary.indexOf(token, cursor)
      if (tokenIndex !== -1 && tokenIndex < nextHighlightIndex) {
        nextHighlightIndex = tokenIndex
      }
    }

    segments.push({
      text: summary.slice(cursor, nextHighlightIndex),
      highlight: false,
    })
    cursor = nextHighlightIndex
  }

  return segments
}

const SUMMARY_BULLET_PATTERN = /^-\s*/
const summaryLines = profile?.summary?.split("\n") ?? []
const trimmedSummaryLines = summaryLines.map((line) => line.trim())
const nonEmptySummaryLines = trimmedSummaryLines.filter((line) => line.length > 0)
const isBulletOnlySummary =
  nonEmptySummaryLines.length > 0 &&
  nonEmptySummaryLines.every((line) => SUMMARY_BULLET_PATTERN.test(line))
const summaryBullets = isBulletOnlySummary
  ? nonEmptySummaryLines
      .map((line) => line.replace(SUMMARY_BULLET_PATTERN, "").trim())
      .filter((line) => line.length > 0)
  : []
const hasSummaryBullets = summaryBullets.length > 0
const summaryBulletSegments = summaryBullets.map((bullet) => tokenizeSummary(bullet))
const summarySegments = tokenizeSummary(profile?.summary)
---

<header
  id="profile"
  class="mb-12 space-y-6"
>
  <div class="space-y-2">
    <h1
      class="text-5xl font-heading font-bold tracking-tight text-resume-text-heading sm:text-6xl"
    >
      {profile?.name}
    </h1>
    <p class="text-xl text-resume-text-muted font-medium font-heading">
      {profile?.label}
    </p>
  </div>

  <div class="flex flex-col gap-2 text-sm text-resume-text-muted">
    {
      profile?.email && (
        <a
          href={`mailto:${profile.email}`}
          class="hover:text-resume-primary focus-visible:text-resume-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-resume-bg rounded-sm transition-colors w-fit"
          data-ga-event="contact_click"
          data-ga-method="email"
        >
          {profile.email}
        </a>
      )
    }
    <div class="flex flex-wrap gap-4">
      {
        profile?.url && (
          <a
            href={profile.url}
            target="_blank"
            rel="noopener noreferrer"
            class="hover:text-resume-primary focus-visible:text-resume-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-resume-bg rounded-sm transition-colors"
            data-ga-event="contact_click"
            data-ga-method="website"
          >
            Website
          </a>
        )
      }
      {profile?.profiles?.map((p, index) => (
        <>
          {(profile?.url || index > 0) && <span>•</span>}
          <a
            href={p.url}
            target="_blank"
            rel="noopener noreferrer"
            class="hover:text-resume-primary focus-visible:text-resume-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-resume-bg rounded-sm transition-colors"
            data-ga-event="contact_click"
            data-ga-method={p.network.toLowerCase()}
          >
            {p.network}
          </a>
        </>
      ))}
    </div>
  </div>

  {
    hasSummaryBullets ? (
      <ul class="text-resume-text-main w-full list-disc space-y-2 pl-5 leading-relaxed marker:text-resume-primary">
        {summaryBulletSegments.map((segments) => (
          <li>
            {segments.map((segment) =>
              segment.highlight ? (
                <span class="font-semibold text-resume-primary">{segment.text}</span>
              ) : (
                segment.text
              ),
            )}
          </li>
        ))}
      </ul>
    ) : (
      <p class="text-resume-text-main leading-relaxed w-full">
        {
          summarySegments.length > 0
            ? summarySegments.map((segment) =>
                segment.highlight ? (
                  <span class="font-semibold text-resume-primary">{segment.text}</span>
                ) : (
                  segment.text
                ),
              )
            : profile?.summary
        }
      </p>
    )
  }
</header>
